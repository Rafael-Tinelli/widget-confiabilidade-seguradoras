# .github/workflows/refresh-data.yml
name: refresh-data

on:
  workflow_dispatch:
  schedule:
    - cron: "30 9 * * 1"

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint
        run: |
          set -euo pipefail
          ruff check .

      # ---------------------
      # Build core datasets
      # ---------------------

      - name: Build JSON (insurers)
        run: |
          set -euo pipefail
          python -m api.build_insurers
        env:
          MIN_INSURERS_COUNT: "200"
          MAX_COUNT_DROP_PCT: "0.20"

          # SES (fontes estáveis, sem depender de HTML/layout)
          SES_ZIP_URL: "https://www2.susep.gov.br/redarq.asp?arq=BaseCompleta%2ezip"
          SES_LISTAEMPRESAS_URL: "https://www2.susep.gov.br/menuestatistica/ses/download/LISTAEMPRESAS.csv"

          # Mantém só se o runner realmente precisar (como estava no seu log)
          SES_ALLOW_INSECURE_SSL: "1"


      - name: Build JSON (consumidor.gov)
        run: |
          set -euo pipefail
          python -m api.build_consumidor_gov
        env:
          # janela padrão (pode sobrescrever no dispatch)
          CONSUMIDOR_GOV_MONTHS: "12"
          # opcional: mais debug
          # CONSUMIDOR_GOV_DEBUG: "1"

      - name: Build JSON (participants)
        run: |
          set -euo pipefail
          python -m api.build_json
        env:
          OPIN_PARTICIPANTS_URL: "https://www.gov.br/susep/pt-br/acesso-a-informacao/dados-abertos/dados-abertos-susep/participe-do-mercado/relacao-de-sociedades-seguradoras-e-entidades-abertas-de-previdencia-complementar-e-capitalizacao"
          OPIN_ALLOW_INSECURE_SSL: "1"

      # ---------------------
      # Smoke checks + guards
      # ---------------------

      - name: Smoke check outputs
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os, sys
          from pathlib import Path

          def fail(msg: str) -> None:
              print("FAIL:", msg, file=sys.stderr, flush=True)
              sys.exit(1)

          # --- 1) insurers.json ---
          insurers_path = Path("api/v1/insurers.json")
          if not insurers_path.exists():
              fail("api/v1/insurers.json não encontrado")
          insurers = json.loads(insurers_path.read_text(encoding="utf-8"))
          meta = insurers.get("meta") or {}
          count = int(meta.get("count") or 0)
          if count < int(os.environ.get("MIN_INSURERS_COUNT", "200")):
              fail(f"insurers count baixo: {count}")

          # --- 2) Consumidor.gov agg + monthly as_of ---
          agg_path = Path("data/derived/consumidor_gov/consumidor_gov_agg_latest.json")
          if not agg_path.exists():
              fail("consumidor_gov_agg_latest.json não encontrado")
          agg = json.loads(agg_path.read_text(encoding="utf-8"))
          m = agg.get("meta") or {}
          as_of = str(m.get("as_of") or "")
          if len(as_of) != 7 or as_of[4] != "-":
              fail(f"consumidor_gov meta.as_of inválido: {as_of!r}")
          wm = int(m.get("window_months") or 0)
          if wm <= 0:
              fail(f"consumidor_gov meta.window_months inválido: {wm}")
          months = m.get("months")
          if not isinstance(months, list) or len(months) < 6:
              fail(f"consumidor_gov meta.months inválido: {months!r}")

          by_name = agg.get("by_name_key") or {}
          if not isinstance(by_name, dict) or len(by_name) < 50:
              fail(f"consumidor_gov by_name_key muito pequeno: {len(by_name) if isinstance(by_name, dict) else 'n/a'}")

          # Guardrail CNPJ (best-effort):
          # - Se o builder expõe meta.cnpj.detected_months e houver detecção,
          #   então o agregado deve ter chaves por CNPJ.
          # - Se não houver metadados de CNPJ, não falha hard (dataset pode não expor).
          cnpj_meta = m.get("cnpj") if isinstance(m.get("cnpj"), dict) else {}
          detected_months = cnpj_meta.get("detected_months") or []
          unique_keys = cnpj_meta.get("unique_keys")
          by_cnpj = agg.get("by_cnpj_key") if isinstance(agg.get("by_cnpj_key"), dict) else {}
          if isinstance(detected_months, list) and len(detected_months) > 0:
              if not isinstance(unique_keys, int):
                  unique_keys = len(by_cnpj)
              if unique_keys <= 0:
                  fail("consumidor_gov: coluna CNPJ detectada em algum mês, mas agregado tem 0 chaves por CNPJ")
          else:
              if isinstance(by_cnpj, dict) and len(by_cnpj) == 0:
                  print("WARN: consumidor_gov sem chaves por CNPJ (matching será por nome).", flush=True)

          # --- 3) Participants/OPIN ---
          participants_path = Path("data/derived/participants/participants_latest.json")
          if not participants_path.exists():
              fail("participants_latest.json não encontrado")
          part = json.loads(participants_path.read_text(encoding="utf-8"))
          pmeta = part.get("meta") or {}
          pcount = int(pmeta.get("count") or 0)
          if pcount < 50:
              fail(f"participants count baixo: {pcount}")

          print("OK: smoke checks passaram.", flush=True)
          PY

      # ---------------------
      # Commit back to repo
      # ---------------------

      - name: Commit outputs
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add api/v1/insurers.json data/derived data/snapshots || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore(data): refresh datasets"
          git push
