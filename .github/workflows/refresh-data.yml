# .github/workflows/refresh-data.yml
name: refresh data

on:
  workflow_dispatch:
  schedule:
    - cron: "17 6 * * 0" # domingo 06:17 UTC

permissions:
  contents: write

concurrency:
  group: refresh-data
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- SETUP AMBIENTE (PYTHON + NODE) ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Cache removido para evitar erros de setup inicial

      # --- CONFIGURAÇÃO DE REDE ---
      - name: Configure Network Proxy Bypass
        run: |
          set -euo pipefail
          echo "NO_PROXY=${NO_PROXY:+$NO_PROXY,}dados.mj.gov.br,data.directory.opinbrasil.com.br" >> "$GITHUB_ENV"
          echo "no_proxy=${no_proxy:+$no_proxy,}dados.mj.gov.br,data.directory.opinbrasil.com.br" >> "$GITHUB_ENV"

      # --- INSTALAÇÃO DEPS (MOVIDO PARA CIMA) ---
      # Instalamos primeiro para garantir que o 'certifi' exista
      - name: Install Python deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # Garante certifi explicitamente caso não esteja no requirements
          pip install certifi 
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      # --- PIN CA BUNDLE (AGORA VAI FUNCIONAR) ---
      - name: Pin CA bundle for requests
        run: |
          set -euo pipefail
          CA="$(python - <<'PY'
          import certifi
          print(certifi.where())
          PY
          )"
          echo "REQUESTS_CA_BUNDLE=$CA" >> "$GITHUB_ENV"
          echo "SSL_CERT_FILE=$CA" >> "$GITHUB_ENV"

      # --- PIPELINE DE DADOS (PYTHON) ---
      - name: Build JSON (participants)
        run: |
          set -euo pipefail
          python -m api.build_json
        env:
          OPIN_PARTICIPANTS_URL: "https://data.directory.opinbrasil.com.br/participants"

      - name: Build Consumidor.gov Data
        timeout-minutes: 30
        run: |
          set -euo pipefail
          python -m api.build_consumidor_gov
        env:
          SES_LISTAEMPRESAS_URL: "https://www2.susep.gov.br/menuestatistica/ses/download/LISTAEMPRESAS.csv"
          SES_CACHE_DIR: "data/raw/ses"

      - name: Build JSON (insurers + intelligence)
        run: |
          set -euo pipefail
          python -m api.build_insurers
        env:
          SES_ZIP_URL: "https://www2.susep.gov.br/redarq.asp?arq=BaseCompleta%2ezip"
          SES_LISTAEMPRESAS_URL: "https://www2.susep.gov.br/menuestatistica/ses/download/LISTAEMPRESAS.csv"
          SES_CACHE_DIR: "data/raw/ses"
          MIN_INSURERS_COUNT: "200"
          MAX_COUNT_DROP_PCT: "0.20"
          SES_ALLOW_INSECURE_SSL: "1"

      # --- PIPELINE DE FRONTEND (NODE/REACT) ---
      - name: Build Frontend Widget
        working-directory: ./widget-ui
        run: |
          npm install
          npm run build

      # --- VERIFICAÇÃO (SMOKE CHECK) ---
      - name: Smoke-check (outputs + connectivity)
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          import re
          from datetime import datetime, timezone
          from pathlib import Path
          
          def fail(msg: str) -> None:
              raise SystemExit(f"SMOKE FAIL: {msg}")

          def load_json(p: Path) -> dict:
              if not p.exists():
                  fail(f"arquivo não existe: {p}")
              if p.stat().st_size < 50:
                  fail(f"arquivo muito pequeno: {p} ({p.stat().st_size} bytes)")
              try:
                  return json.loads(p.read_text(encoding="utf-8"))
              except Exception as e:
                  fail(f"JSON inválido em {p}: {e}")

          # 1) insurers.json
          insurers_path = Path("api/v1/insurers.json")
          ins = load_json(insurers_path)
          count = int(ins.get("meta", {}).get("count", 0) or 0)
          print(f"SMOKE: Insurers count = {count}")

          # 2) Frontend Assets
          widget_js = Path("widget-ui/dist/assets/widget.js")
          
          if not widget_js.exists():
             fail(f"Frontend Build falhou: {widget_js} não encontrado")
          
          print("SMOKE OK: Dados e Frontend gerados.")
          PY
        env:
          MIN_INSURERS_COUNT: "200"
          SES_ALLOW_INSECURE_SSL: "1"

      - name: Run tests
        run: |
          set -euo pipefail
          pytest -q

      - name: Prune old snapshots
        run: |
          set -euo pipefail
          find data/snapshots -maxdepth 1 -name '*.json.gz' -printf '%T@ %p\n' \
            | sort -nr | awk 'NR>60 {print $2}' | xargs -r rm --

      # --- COMMIT FINAL ---
      - name: Commit changes
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Adiciona Dados + Frontend (widget-ui/dist)
          git add -f api/v1 data/raw data/snapshots data/derived widget-ui/dist
          
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore(data): refresh data + rebuild widget ui"
          git push
