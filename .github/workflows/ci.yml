name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure NO_PROXY for dados.mj.gov.br
        run: |
          echo "NO_PROXY=${NO_PROXY:+$NO_PROXY,}dados.mj.gov.br" >> $GITHUB_ENV
          echo "no_proxy=${no_proxy:+$no_proxy,}dados.mj.gov.br" >> $GITHUB_ENV

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r requirements.txt

      - name: Lint
        run: |
          set -euo pipefail
          ruff check .

      - name: Tests
        run: |
          set -euo pipefail
          # Tenta rodar o teste. Se passar, ótimo.
          if pytest -q; then
            echo "pytest OK"
          else
            # Se falhar, imprime o diagnóstico do JSON para sabermos o motivo
            echo ""
            echo "===== DEBUG insurers.json ====="
            python - <<'PY'
          import json
          import sys
          from pathlib import Path

          p = Path("api/v1/insurers.json")
          print(f"exists: {p.exists()}")

          if not p.exists():
              print("ERRO: api/v1/insurers.json nao existe.")
          else:
              print(f"size: {p.stat().st_size}")
              try:
                  data = json.loads(p.read_text(encoding="utf-8"))
                  print(f"schemaVersion: {data.get('schemaVersion')}")
                  print(f"generatedAt: {data.get('generatedAt')}")
                  print(f"meta.count: {data.get('meta', {}).get('count')}")

                  insurers = data.get("insurers", [])
                  print(f"insurers.len: {len(insurers)}")

                  if insurers:
                      it = insurers[0]
                      print(f"first.id: {it.get('id')}")
                      print(f"first.keys: {sorted(it.keys())}")
                      if isinstance(it.get("data"), dict):
                          print(f"first.data.keys: {sorted(it['data'].keys())}")
              except Exception as e:
                  print(f"ERRO ao ler JSON: {e}")
          PY
            echo "===== END DEBUG ====="
            # Força a falha do step para o CI ficar vermelho
            exit 1
          fi
